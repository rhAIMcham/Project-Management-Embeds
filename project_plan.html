<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Critical Path Planner – POC</title>
  <style>
    @import "tailwindcss";
:root {
  font-family: system-ui, Avenir, Helvetica, Arial, sans-serif;
  line-height: 1.5;
  font-weight: 400;
  color-scheme: light dark;
  font-synthesis: none;
  text-rendering: optimizeLegibility;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}


body {
  margin: auto;
  min-width: 320px;
  min-height: 100vh;
}

h1 {
  font-size: 3.2em;
  line-height: 1.1;
}

/* Layout & Container */
.app-container {
  min-height: 100vh;
  background-color: #f9fafb;
  color: #111827;
}

.main-wrapper {
  max-width: 80rem;
  margin-left: auto;
  margin-right: auto;
  padding: 1.5rem;
}

/* Header */
.header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1.5rem;
}

.header-title {
  font-size: 1.5rem;
  line-height: 2rem;
  font-weight: 600;
}

.stage-indicator {
  display: flex;
  gap: 0.75rem;
  align-items: center;
  background-color: white;
  border-radius: 1rem;
  box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  padding: 1rem;
}

.stage-label {
  font-size: 0.875rem;
  line-height: 1.25rem;
  color: #4b5563;
}

.stage-badge {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  line-height: 1.25rem;
  background-color: #e5e7eb;
}

/* Sections */
.section-card {
  background-color: white;
  border-radius: 1rem;
  box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  padding: 1rem;
  margin-bottom: 1rem;
}

.section-card.mt-4 {
  margin-top: 1rem;
}

.section-title {
  font-weight: 500;
  margin-bottom: 0.5rem;
}

/* Project Selector */
.project-buttons {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.project-button {
  padding: 0.5rem 0.75rem;
  border-radius: 0.75rem;
  border: 1px solid transparent;
  background-color: white;
  cursor: pointer;
  color: black;
}

.project-button:hover {
  background-color: #f9fafb;
}

.project-button.active {
  background-color: #eef2ff;
  border-color: #c7d2fe;
}

.project-button-title {
  font-weight: 500;
}

.project-button-subtitle {
  font-size: 0.75rem;
  line-height: 1rem;
  color: #6b7280;
  text-align: left;
}

.instructions-text {
  margin-top: 0.75rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
  color: #4b5563;
}

/* Gantt Chart */
.gantt-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.75rem;
}

.duration-display {
  font-size: 0.875rem;
  line-height: 1.25rem;
  color: #4b5563;
}

.duration-value {
  font-weight: 600;
}

/* Chart Area */
.chart-container {
  position: relative;
  width: 100%;
}

/* Scale Header */
.scale-header {
  position: sticky;
  top: 0;
  z-index: 10;
  background-color: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(8px);
  border-radius: 0.75rem 0.75rem 0 0;
}

.scale-grid {
  display: grid;
}

.scale-label {
  font-size: 0.75rem;
  line-height: 1rem;
  text-align: center;
  color: #6b7280;
}

/* Task Rows */
.rows-container {
  margin-top: 0.25rem;
  position: relative;
}

/* Grid Lines */
.grid-overlay {
  position: absolute;
  left: 0;
  right: 0;
  top: 0;
  bottom: 0;
}

.grid-inner {
  height: 100%;
  display: grid;
}

.grid-line {
  border-right: 1px dashed #e5e7eb;
}

/* Task Bars */
.task-row {
  position: absolute;
  left: 0;
}

.task-bar {
  position: relative;
  height: 4rem;
  border-radius: 1rem;
  box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  padding-left: 0.75rem;
  padding-right: 0.75rem;
  z-index: 10;
}

.task-bar.critical {
  background-color: #ef4444;
}

.task-bar.non-critical {
  background-color: #6366f1;
}

.task-bar.interactive {
  cursor: grab;
}

.task-bar.static {
  cursor: default;
}

/* Task Labels */
.task-label-container {
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  pointer-events: none;
}

.task-name {
  font-size: 0.75rem;
  line-height: 1rem;
  font-weight: 500;
  color: white;
}

.task-info {
  font-size: 0.625rem;
  opacity: 0.9;
}

/* Corner Inputs */
.corner-input {
  position: absolute;
  width: 2rem;
  padding: 0.125rem 0.25rem;
  border-radius: 0.375rem;
  border: 1px solid;
  font-size: 0.625rem;
}

.corner-input.es {
  top: 0.25rem;
  left: 0.25rem;
}

.corner-input.ef {
  top: 0.25rem;
  right: 0.25rem;
  text-align: right;
}

.corner-input.ls {
  bottom: 0.25rem;
  left: 0.25rem;
}

.corner-input.lf {
  bottom: 0.25rem;
  right: 0.25rem;
  text-align: right;
}

.corner-input.active {
  background-color: white;
  color: #1f2937;
}

.corner-input.disabled {
  background-color: rgba(255, 255, 255, 0.4);
  color: rgba(255, 255, 255, 0.8);
  border-color: rgba(255, 255, 255, 0.2);
}

/* SVG Arrows */
.arrows-overlay {
  position: absolute;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

/* Controls */
.controls-container {
  margin-top: 1rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.btn-primary {
  padding: 0.5rem 1rem;
  border-radius: 0.75rem;
  background-color: #4f46e5;
  color: white;
  border: none;
  cursor: pointer;
}

.btn-primary:hover {
  background-color: #4338ca;
}

.btn-success {
  padding: 0.5rem 1rem;
  border-radius: 0.75rem;
  background-color: #16a34a;
  color: white;
  border: none;
  cursor: pointer;
}

.btn-success:hover {
  background-color: #15803d;
}

.btn-secondary {
  padding: 0.5rem 0.75rem;
  border-radius: 0.75rem;
  background-color: #f3f4f6;
  border: none;
  cursor: pointer;
  color: black;
}

.btn-secondary:hover {
  background-color: #e5e7eb;
}

.btn-reset {
  margin-left: auto;
}

.interactive-hint {
  font-size: 0.875rem;
  line-height: 1.25rem;
  color: #374151;
}

/* Legend */
.legend-container {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 1rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.legend-swatch {
  display: inline-block;
  width: 1rem;
  height: 1rem;
  border-radius: 0.25rem;
}

.legend-swatch.critical {
  background-color: #ef4444;
}

.legend-swatch.non-critical {
  background-color: #6366f1;
}

.legend-text {
  color: #4b5563;
}

/* Modal */
.modal-overlay {
  position: fixed;
  inset: 0;
  z-index: 50;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(0, 0, 0, 0.4);
  color: black;
}

.modal-content {
  background-color: white;
  border-radius: 1rem;
  box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
  width: 100%;
  max-width: 80%;
  padding: 1.5rem;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 1rem;
  color: black;
}

.modal-title {
  font-size: 1.25rem;
  line-height: 1.75rem;
  font-weight: 600;
}

.modal-close {
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  background-color: #f3f4f6;
  border: none;
  cursor: pointer;
  color: black;
}

.modal-close:hover {
  background-color: #e5e7eb;
}

.modal-body {
  color: #374151;
}

/* Modal Content Styles */
.modal-body p {
  margin-bottom: 0.5rem;
}

.modal-body .space-y-2 > * + * {
  margin-top: 0.5rem;
}

.modal-body ul {
  list-style-type: disc;
  padding-left: 1.25rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.modal-body b {
  font-weight: 700;
}

/* Project Management */
.project-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 0.75rem;
}

.project-controls {
  display: flex;
  gap: 0.5rem;
}

.btn-sm {
  padding: 0.375rem 0.75rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.btn-xs {
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  line-height: 1rem;
}

.project-name-editor {
  margin-top: 1rem;
  margin-bottom: 0.75rem;
}

#project-name {
  width: 250px;
}

.project-name-text {
  font-size: 1.25rem;
  font-weight: 600;
  color: #374151;
  margin: 0;
  padding: 0.5rem;
}

.project-name-input {
  font-size: 1.25rem;
  font-weight: 600;
  color: #374151;
  padding: 0.5rem;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  width: 100%;
  max-width: 400px;
  background-color: white;
}

.project-name-input:focus {
  outline: none;
  border-color: #7c3aed;
  box-shadow: 0 0 0 2px rgba(124, 58, 237, 0.1);
}

.form-group {
  margin-bottom: 1rem;
}

.form-label {
  display: block;
  font-weight: 500;
  margin-bottom: 0.5rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.form-input {
  width: 100%;
  padding: 0.5rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 0.5rem;
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.form-input:focus {
  outline: none;
  border-color: #6366f1;
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

/* Task List */
.empty-state {
  padding: 2rem;
  text-align: center;
  color: #6b7280;
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.task-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.task-list-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  background-color: #f9fafb;
}

.task-list-info {
  display: flex;
  align-items: center;
  gap: 1rem;
  flex: 1;
}

.task-id {
  font-weight: 600;
  color: #4f46e5;
  min-width: 2rem;
}

.task-list-info .task-name {
  font-weight: 500;
  color: #111827;
  flex: 1;
}

.task-duration {
  font-size: 0.75rem;
  line-height: 1rem;
  color: #6b7280;
}

.task-deps {
  font-size: 0.75rem;
  line-height: 1rem;
  color: #6b7280;
  font-style: italic;
}

.task-list-actions {
  display: flex;
  gap: 0.5rem;
}

/* Task Editor Modal */
.task-editor-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.deps-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  max-height: 200px;
  overflow-y: auto;
  padding: 0.5rem;
  border: 1px solid #e5e7eb;
  border-radius: 0.5rem;
  background-color: #f9fafb;
}

.deps-empty {
  color: #6b7280;
  font-size: 0.875rem;
  line-height: 1.25rem;
  text-align: center;
  padding: 1rem;
}

.dep-checkbox {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem;
  border-radius: 0.375rem;
  cursor: pointer;
}

.dep-checkbox:hover {
  background-color: #f3f4f6;
}

.dep-checkbox input[type="checkbox"] {
  width: 1rem;
  height: 1rem;
  cursor: pointer;
}

.dep-checkbox span {
  font-size: 0.875rem;
  line-height: 1.25rem;
}

.form-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
  margin-top: 0.5rem;
  padding-top: 1rem;
  border-top: 1px solid #e5e7eb;
}

/* AI Evaluation Results */
.evaluationContents {
  color: black;
}

.evaluation-results h1,
.evaluation-results h2,
.evaluation-results h3 {
  margin-top: 1.5rem;
  margin-bottom: 0.75rem;
  font-weight: 600;
}

.evaluation-results h1 {
  font-size: 1.25rem;
  line-height: 1.75rem;
}

.evaluation-results h2 {
  font-size: 1.125rem;
  line-height: 1.5rem;
}

.evaluation-results h3 {
  font-size: 1rem;
  line-height: 1.5rem;
}

.evaluation-results p {
  margin-bottom: 0.75rem;
}

.evaluation-results ul,
.evaluation-results ol {
  margin-left: 1.5rem;
  margin-bottom: 0.75rem;
}

.evaluation-results li {
  margin-bottom: 0.5rem;
}

.evaluation-results strong {
  font-weight: 600;
}

.evaluation-results code {
  background-color: #f3f4f6;
  padding: 0.125rem 0.375rem;
  border-radius: 0.25rem;
  font-family: 'Courier New', monospace;
  font-size: 0.875rem;
}
  </style>
</head>
<body>
  <div class="app-container">
    <div class="main-wrapper">
      <header class="header">
        <h1 class="header-title">Critical Path Planner – POC</h1>
        <div class="stage-indicator">
          <span class="stage-label">Stage:</span>
          <span class="stage-badge" id="stage-badge">Enter ES/EF</span>
        </div>
      </header>

      <!-- Project selector -->
      <section class="section-card">
        <div class="project-header">
          <h2 class="section-title">Projects</h2>
          <div class="project-controls">
            <button class="btn-primary btn-sm" onclick="addProject()">+ Add Project</button>
            <button class="btn-secondary btn-sm" onclick="deleteProject()">Delete Project</button>
          </div>
        </div>
        <div class="project-buttons" id="project-buttons"></div>
        
        <!-- Editable project name -->
        <div class="project-name-editor">
           <div id="project-name-container"></div>
          <!-- <label class="form-label">Project Name:</label>
          <input type="text" class="form-input" id="project-name"> -->
        </div>

        <div class="instructions-text">
          1) Enter ES/EF in each bar, then check. 2) Enter LS/LF, then check. 3) Drag bars to explore slack & critical path changes.
        </div>
      </section>

      <!-- Task management -->
      <section class="section-card" id="taskAddSection">
        <div class="project-header">
          <h2 class="section-title">Tasks</h2>
          <button class="btn-primary btn-sm" onclick="addTask()">+ Add Task</button>
        </div>
        <div id="task-list"></div>
      </section>

      <!-- Gantt -->
      <section class="section-card" id="gantt-section">
        <div class="gantt-header">
          <h2 class="section-title">Gantt Chart</h2>
          <div class="duration-display">Project duration: <span class="duration-value" id="project-duration">0</span> units</div>
        </div>

        <div id="chart-container" class="chart-container">
          <!-- Scale header -->
          <div class="scale-header">
            <div class="scale-grid" id="scale-grid"></div>
          </div>

          <!-- Rows + dependency arrows -->
          <div class="rows-container" id="rows-container">
            <!-- Grid columns -->
            <div class="grid-overlay" style="margin-left: 24px;">
              <div class="grid-inner" id="grid-inner"></div>
            </div>

            <!-- Task bars -->
            <div id="task-bars"></div>

            <!-- Dependency arrows overlay -->
            <svg class="arrows-overlay" id="arrows-svg">
              <defs>
                <marker id="arrow" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto-start-reverse">
                  <path d="M0,0 L8,4 L0,8 Z" fill="#9ca3af" />
                </marker>
                <marker id="arrow-red" markerWidth="8" markerHeight="8" refX="8" refY="4" orient="auto-start-reverse">
                  <path d="M0,0 L8,4 L0,8 Z" fill="#ef4444" />
                </marker>
              </defs>
              <g id="arrow-paths"></g>
            </svg>
          </div>
        </div>

        <!-- Controls -->
        <div class="controls-container" id="controls-container"></div>
      </section>

      <!-- Legend & tips -->
      <section class="section-card mt-4">
        <div class="legend-container">
          <div class="legend-item">
            <span class="legend-swatch critical"></span>
            <span>Critical path</span>
          </div>
          <div class="legend-item">
            <span class="legend-swatch non-critical"></span>
            <span>Non-critical task</span>
          </div>
          <div class="legend-text">Slack = LS − ES (shown inside each task bar).</div>
          <button class="btn-secondary btn-sm" onclick="resetProjectData()">Reset Project</button>
        </div>
      </section>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title"></h3>
        <button class="modal-close" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <!-- Task Editor Modal -->
  <div id="task-editor-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title" id="task-editor-title">Add New Task</h3>
        <button class="modal-close" onclick="closeTaskEditor()">✕</button>
      </div>
      <div class="modal-body">
        <div class="task-editor-form">
          <div class="form-group">
            <label class="form-label">Task ID</label>
            <input type="text" class="form-input" id="task-id" maxlength="3">
          </div>
          
          <div class="form-group">
            <label class="form-label">Task Name</label>
            <input type="text" class="form-input" id="task-name-input" placeholder="e.g., Prep walls">
          </div>
          
          <div class="form-group">
            <label class="form-label">Duration (time units)</label>
            <input type="number" class="form-input" id="task-duration" min="1">
          </div>
          
          <div class="form-group">
            <label class="form-label">Dependencies (predecessors)</label>
            <div class="deps-list" id="deps-list"></div>
          </div>
          
          <div class="form-actions">
            <button class="btn-secondary" onclick="closeTaskEditor()">Cancel</button>
            <button class="btn-primary" onclick="saveTask()">Save Task</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="task-management" class="mb-3">
    <!-- Task management buttons will be inserted here -->
  </div>

  <script>
// ============================================================================
// TYPE DEFINITIONS
// ============================================================================

/**
 * @typedef {Object} Task
 * @property {string} id
 * @property {string} name
 * @property {number} duration
 * @property {string[]} deps
 */

/**
 * @typedef {Object} Project
 * @property {string} id
 * @property {string} name
 * @property {Task[]} tasks
 */

// ============================================================================
// CONSTANTS
// ============================================================================

const INITIAL_PROJECTS = [
  {
    id: "p1",
    name: "House Painting Mini-Project",
    tasks: [
      { id: "A", name: "Prep walls", duration: 4, deps: [] },
      { id: "B", name: "Mask & cover", duration: 3, deps: ["A"] },
      { id: "C", name: "Buy paint", duration: 3, deps: ["A"] },
      { id: "D", name: "Roll first coat", duration: 5, deps: ["B", "C"] },
      { id: "E", name: "Second coat", duration: 3, deps: ["D"] },
    ],
  },
  {
    id: "p2",
    name: "Website Landing Page",
    tasks: [
      { id: "A", name: "Requirements", duration: 3, deps: [] },
      { id: "B", name: "Wireframes", duration: 3, deps: ["A"] },
      { id: "C", name: "Copywriting", duration: 4, deps: ["A"] },
      { id: "D", name: "Visual Design", duration: 5, deps: ["B"] },
      { id: "E", name: "Frontend Build", duration: 6, deps: ["D", "C"] },
      { id: "F", name: "QA & Fixes", duration: 3, deps: ["E"] },
      { id: "G", name: "Launch", duration: 3, deps: ["F"] },
    ],
  },
  {
    id: "p3",
    name: "Event Planning Weekend",
    tasks: [
      { id: "A", name: "Book venue", duration: 3, deps: [] },
      { id: "B", name: "Catering quotes", duration: 3, deps: [] },
      { id: "C", name: "Speakers", duration: 4, deps: ["A"] },
      { id: "D", name: "Marketing", duration: 5, deps: ["A"] },
      { id: "E", name: "Confirm catering", duration: 3, deps: ["B"] },
      { id: "F", name: "Run of show", duration: 3, deps: ["C", "E"] },
      { id: "G", name: "Dry run", duration: 3, deps: ["F", "D"] },
    ],
  },
];

const DEFAULT_PROJECT_IDS = ['p1', 'p2', 'p3'];
const ROW_HEIGHT = 112;
const BAR_HEIGHT = 64;
const PADDING = 24;

// ============================================================================
// STATE MANAGEMENT
// ============================================================================

const state = {
  projects: JSON.parse(JSON.stringify(INITIAL_PROJECTS)),
  currentProjectId: INITIAL_PROJECTS[0].id,
  stage: "esef",
  ESin: {},
  EFin: {},
  LSin: {},
  LFin: {},
  minStart: {},
  unitWidth: 28,
  dragging: null,
  editingTask: null,
  isEvaluating: false,
  warningShown: false
};

function getCurrentProject() {
  return state.projects.find(p => p.id === state.currentProjectId) || state.projects[0];
}

function isDefaultProject(projectId) {
  return DEFAULT_PROJECT_IDS.includes(projectId);
}

function resetProjectState() {
  state.ESin = {};
  state.EFin = {};
  state.LSin = {};
  state.LFin = {};
  state.minStart = {};
  state.stage = "esef";
}

// ============================================================================
// CPM ALGORITHM
// ============================================================================

function topoSort(tasks) {
  const indeg = {};
  const graph = {};
  
  tasks.forEach(t => {
    indeg[t.id] = indeg[t.id] || 0;
    t.deps.forEach(d => {
      indeg[t.id] = (indeg[t.id] || 0) + 1;
      graph[d] = graph[d] || [];
      graph[d].push(t.id);
    });
  });
  
  const q = tasks.filter(t => (indeg[t.id] || 0) === 0).map(t => t.id);
  const order = [];
  
  while (q.length) {
    const u = q.shift();
    order.push(u);
    (graph[u] || []).forEach(v => {
      indeg[v] -= 1;
      if (indeg[v] === 0) q.push(v);
    });
  }
  
  if (order.length !== tasks.length) {
    console.warn("Cycle detected or missing tasks");
  }
  
  return order;
}

function computeCPM(tasks, minStart = {}) {
  const order = topoSort(tasks);
  const byId = Object.fromEntries(tasks.map(t => [t.id, t]));
  
  const ES = {};
  const EF = {};
  
  // Forward pass
  for (const id of order) {
    const t = byId[id];
    const preds = t.deps;
    const predEF = preds.length ? Math.max(...preds.map(p => EF[p])) : 0;
    const start = Math.max(predEF, minStart[id] || 0);
    ES[id] = start;
    EF[id] = start + t.duration;
  }
  
  const projectDuration = Math.max(...Object.values(EF), 0);
  
  // Backward pass
  const succs = {};
  tasks.forEach(t => t.deps.forEach(d => {
    succs[d] = succs[d] || [];
    succs[d].push(t.id);
  }));
  
  const LS = {};
  const LF = {};
  const rev = [...order].reverse();
  
  for (const id of rev) {
    const t = byId[id];
    const s = succs[id] || [];
    LF[id] = s.length === 0 ? projectDuration : Math.min(...s.map(v => LS[v]));
    LS[id] = LF[id] - t.duration;
  }
  
  // Calculate slack and critical path
  const slack = {};
  const critical = new Set();
  for (const t of tasks) {
    slack[t.id] = LS[t.id] - ES[t.id];
    if (Math.abs(slack[t.id]) < 1e-9) critical.add(t.id);
  }
  
  return { ES, EF, LS, LF, slack, critical, projectDuration };
}

// ============================================================================
// RENDERING - MAIN
// ============================================================================

function render() {
  renderHeader();
  renderProjectSelector();
  renderTaskList();
  renderGantt();
}

function renderHeader() {
  const stageNames = {
    esef: "Enter ES/EF",
    lslf: "Enter LS/LF",
    interactive: "Interactive dragging"
  };
  document.getElementById('stage-badge').textContent = stageNames[state.stage];
}

// ============================================================================
// RENDERING - PROJECT SELECTOR
// ============================================================================

function renderProjectSelector() {
  const container = document.getElementById('project-buttons');
  container.innerHTML = '';
  
  state.projects.forEach(p => {
    const btn = document.createElement('button');
    btn.className = `project-button ${state.currentProjectId === p.id ? 'active' : ''}`;
    btn.innerHTML = `
      <div class="project-button-title">${p.name}</div>
      <div class="project-button-subtitle">${p.tasks.length} tasks</div>
    `;
    btn.onclick = () => switchProject(p.id);
    container.appendChild(btn);
  });
  
  const project = getCurrentProject();
  const projectNameContainer = document.getElementById('project-name-container');
  
  // Clear existing content
  projectNameContainer.innerHTML = '';
  
  if (isDefaultProject(state.currentProjectId)) {
    // For default projects, show as plain text
    const nameElement = document.createElement('p');
    nameElement.id = 'project-name';
    nameElement.className = 'project-name-text';
    nameElement.textContent = project.name;
    projectNameContainer.appendChild(nameElement);
  } else {
    // For custom project, show as input
    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.id = 'project-name';
    nameInput.className = 'project-name-input';
    nameInput.value = project.name;
    nameInput.addEventListener('input', (e) => updateProjectName(e.target.value));
    projectNameContainer.appendChild(nameInput);
  }
  
  // Show/hide task add section based on project type
  const taskAddSection = document.getElementById('taskAddSection');
  if (taskAddSection) {
    taskAddSection.style.display = isDefaultProject(state.currentProjectId) ? 'none' : 'block';
  }
}

function switchProject(projectId) {
  state.currentProjectId = projectId;
  resetProjectState();
  render();
}

// ============================================================================
// RENDERING - TASK LIST
// ============================================================================

function renderTaskList() {
  const project = getCurrentProject();
  const container = document.getElementById('task-list');
  
  if (project.tasks.length === 0) {
    container.innerHTML = '<div class="empty-state">No tasks yet. Click "Add Task" to get started.</div>';
    return;
  }
  
  container.innerHTML = '';
  project.tasks.forEach(t => {
    const div = document.createElement('div');
    div.className = 'task-list-item';
    div.innerHTML = `
      <div class="task-list-info">
        <span class="task-id">${t.id}</span>
        <span class="task-name">${t.name}</span>
        <span class="task-duration">Duration: ${t.duration}</span>
        <span class="task-deps">
          ${t.deps.length > 0 ? `Depends on: ${t.deps.join(', ')}` : 'No dependencies'}
        </span>
      </div>
      <div class="task-list-actions">
        <button class="btn-secondary btn-xs" onclick="editTask('${t.id}')">Edit</button>
        <button class="btn-secondary btn-xs" onclick="deleteTask('${t.id}')">Delete</button>
      </div>
    `;
    container.appendChild(div);
  });
}

// ============================================================================
// RENDERING - GANTT CHART
// ============================================================================

function renderGantt() {
  const project = getCurrentProject();
  const container = document.getElementById('gantt-section');
  
  if (project.tasks.length === 0) {
    container.style.display = 'none';
    return;
  }
  
  container.style.display = 'block';
  
  const computed = computeCPM(project.tasks, state.minStart);
  const maxTime = Math.max(computed.projectDuration + 3, 12);
  
  document.getElementById('project-duration').textContent = computed.projectDuration;
  
  // Update unit width based on container size
  const chartContainer = document.getElementById('chart-container');
  const available = Math.max(0, chartContainer.clientWidth - PADDING);
  if (maxTime > 0) {
    state.unitWidth = available / maxTime;
  }
  
  renderScale(maxTime);
  renderTaskBars(project, computed, maxTime);
  renderArrows(project, computed, maxTime);
  renderControls(project, computed);
}

function renderScale(maxTime) {
  const scaleGrid = document.getElementById('scale-grid');
  scaleGrid.style.marginLeft = PADDING + 'px';
  scaleGrid.style.gridTemplateColumns = `repeat(${maxTime + 1}, 1fr)`;
  scaleGrid.innerHTML = '';
  
  for (let i = 0; i <= maxTime; i++) {
    const label = document.createElement('div');
    label.className = 'scale-label';
    label.textContent = i;
    scaleGrid.appendChild(label);
  }
}

function renderTaskBars(project, computed, maxTime) {
  const container = document.getElementById('rows-container');
  container.style.height = (project.tasks.length * ROW_HEIGHT) + 'px';
  
  renderGridOverlay(maxTime);
  
  const barsContainer = document.getElementById('task-bars');
  barsContainer.innerHTML = '';
  
  project.tasks.forEach((t, rowIdx) => {
    const bar = createTaskBar(t, rowIdx, computed, project);
    barsContainer.appendChild(bar);
  });
  
  attachTaskBarListeners();
}

function renderGridOverlay(maxTime) {
  const gridInner = document.getElementById('grid-inner');
  gridInner.style.gridTemplateColumns = `repeat(${maxTime}, 1fr)`;
  gridInner.innerHTML = '';
  
  for (let i = 0; i < maxTime; i++) {
    const line = document.createElement('div');
    line.className = 'grid-line';
    gridInner.appendChild(line);
  }
}

function createTaskBar(task, rowIdx, computed, project) {
  const es = computed.ES[task.id];
  const curStart = (state.stage === "interactive" || !isDefaultProject(state.currentProjectId)) 
    ? (state.minStart[task.id] || es) 
    : es;
  const isCritical = computed.critical.has(task.id);
  const left = PADDING + curStart * state.unitWidth;
  const top = rowIdx * ROW_HEIGHT + 2;
  
  const row = document.createElement('div');
  row.className = 'task-row';
  row.style.top = top + 'px';
  row.style.height = ROW_HEIGHT + 'px';
  
  const bar = document.createElement('div');
  bar.className = `task-bar ${isCritical ? 'critical' : 'non-critical'} ${
    state.stage === 'interactive' || !isDefaultProject(state.currentProjectId) 
      ? 'interactive' 
      : 'static'
  }`;
  bar.style.left = left + 'px';
  bar.style.width = (task.duration * state.unitWidth) + 'px';
  bar.dataset.taskId = task.id;
  
  bar.innerHTML = createTaskBarContent(task, computed, project);
  row.appendChild(bar);
  
  return row;
}

function createTaskBarContent(task, computed, project) {
  const isDefault = isDefaultProject(state.currentProjectId);
  const inESEFStage = state.stage === 'esef';
  
  const esActive = (isDefault && inESEFStage) || !isDefault;
  const lsActive = (isDefault && !inESEFStage) || !isDefault;
  
  return `
    <div class="task-label-container">
      <div class="task-name">${task.id} – ${task.name}</div>
      <div class="task-info">dur ${task.duration} • slack ${computed.slack[task.id]}</div>
    </div>
    ${createCornerInput('ES', task.id, state.ESin[task.id], esActive, isDefault && !inESEFStage)}
    ${createCornerInput('EF', task.id, state.EFin[task.id], esActive, isDefault && !inESEFStage)}
    ${createCornerInput('LS', task.id, state.LSin[task.id], lsActive, isDefault && inESEFStage)}
    ${createCornerInput('LF', task.id, state.LFin[task.id], lsActive, isDefault && inESEFStage)}
  `;
}

function createCornerInput(field, taskId, value, active, disabled) {
  return `
    <input class="corner-input ${field.toLowerCase()} ${active ? 'active' : 'disabled'}"
           placeholder="${field}" 
           value="${value || ''}"
           data-task-id="${taskId}"
           data-field="${field}"
           ${disabled ? 'disabled' : ''}>
  `;
}

function attachTaskBarListeners() {
  document.querySelectorAll('.corner-input').forEach(input => {
    input.addEventListener('input', handleInputChange);
    input.addEventListener('mousedown', e => e.stopPropagation());
  });
  
  document.querySelectorAll('.task-bar').forEach(bar => {
    bar.addEventListener('mousedown', handleBarMouseDown);
  });
}

// ============================================================================
// RENDERING - ARROWS
// ============================================================================

function renderArrows(project, computed, maxTime) {
  const svg = document.getElementById('arrows-svg');
  const viewBoxWidth = PADDING + maxTime * state.unitWidth;
  const viewBoxHeight = project.tasks.length * ROW_HEIGHT;
  svg.setAttribute('viewBox', `0 0 ${viewBoxWidth} ${viewBoxHeight}`);
  
  const paths = project.tasks.flatMap((task, tgtIdx) => 
    createArrowPaths(task, tgtIdx, project, computed)
  ).join('');
  
  document.getElementById('arrow-paths').innerHTML = paths;
}

function createArrowPaths(task, tgtIdx, project, computed) {
  const tgtStart = state.stage === "interactive" || !isDefaultProject(state.currentProjectId)
    ? (state.minStart[task.id] || computed.ES[task.id]) 
    : computed.ES[task.id];
  const tgtStartX = PADDING + tgtStart * state.unitWidth;
  const tgtY = tgtIdx * ROW_HEIGHT + 2 + BAR_HEIGHT / 2;
  
  return task.deps.map(depId => {
    const pred = project.tasks.find(x => x.id === depId);
    if (!pred) return '';
    
    const predStart = state.stage === "interactive" || !isDefaultProject(state.currentProjectId)
      ? (state.minStart[pred.id] || computed.ES[pred.id]) 
      : computed.ES[pred.id];
    const predStartX = PADDING + predStart * state.unitWidth;
    const predEndX = predStartX + pred.duration * state.unitWidth;
    const predIdx = project.tasks.findIndex(x => x.id === depId);
    const predY = predIdx * ROW_HEIGHT + 2 + BAR_HEIGHT / 2;
    
    const elbowX = Math.max(predEndX + 8, Math.min(tgtStartX - 8, predEndX + (tgtStartX - predEndX) / 2));
    const isCritLink = computed.critical.has(depId) && computed.critical.has(task.id);
    const stroke = isCritLink ? "#ef4444" : "#9ca3af";
    const marker = isCritLink ? "url(#arrow-red)" : "url(#arrow)";
    
    const dPath = `M ${predEndX} ${predY} H ${elbowX} V ${tgtY} H ${tgtStartX}`;
    return `<path d="${dPath}" fill="none" stroke="${stroke}" stroke-width="2" marker-end="${marker}" />`;
  });
}

// ============================================================================
// RENDERING - CONTROLS
// ============================================================================

function renderControls(project, computed) {
  const container = document.getElementById('controls-container');
  container.innerHTML = '';
  
  if (isDefaultProject(state.currentProjectId)) {
    renderDefaultProjectControls(container);
  } else {
    renderCustomProjectControls(container, project);
  }
  
  addResetButton(container);
}

function renderDefaultProjectControls(container) {
  const controls = {
    esef: { text: 'Check ES/EF', handler: checkESEF, className: 'btn-primary' },
    lslf: { text: 'Check LS/LF', handler: checkLSLF, className: 'btn-success' },
    interactive: { 
      text: 'Drag any bar. If you move a task beyond its slack, successors will shift and the critical path may change.',
      isHint: true 
    }
  };
  
  const control = controls[state.stage];
  if (control.isHint) {
    const hint = document.createElement('div');
    hint.className = 'interactive-hint';
    hint.textContent = control.text;
    container.appendChild(hint);
  } else {
    const btn = document.createElement('button');
    btn.className = control.className;
    btn.textContent = control.text;
    btn.onclick = control.handler;
    container.appendChild(btn);
  }
}

function renderCustomProjectControls(container, project) {
  const allFieldsFilled = project.tasks.every(t => 
    state.ESin[t.id] && state.EFin[t.id] && state.LSin[t.id] && state.LFin[t.id]
  );
  
  if (allFieldsFilled) {
    const btn = document.createElement('button');
    btn.className = 'btn-primary';
    btn.textContent = state.isEvaluating ? 'Evaluating...' : 'Submit for AI Evaluation';
    btn.disabled = state.isEvaluating;
    btn.style.backgroundColor = '#7c3aed';
    btn.style.opacity = state.isEvaluating ? '0.6' : '1';
    btn.style.cursor = state.isEvaluating ? 'wait' : 'pointer';
    btn.onclick = submitForEvaluation;
    container.appendChild(btn);
  } else {
    const hint = document.createElement('div');
    hint.className = 'interactive-hint';
    hint.textContent = 'Fill in all ES, EF, LS, and LF values to submit for AI evaluation.';
    container.appendChild(hint);
  }
}

function addResetButton(container) {
  const resetBtn = document.createElement('button');
  resetBtn.className = 'btn-secondary btn-reset';
  resetBtn.textContent = 'Reset project';
  resetBtn.onclick = () => {
    resetProjectState();
    render();
  };
  container.appendChild(resetBtn);
}

// ============================================================================
// EVENT HANDLERS - INPUT
// ============================================================================


function handleInputChange(e) {
  const { taskId, field } = e.target.dataset;
  const value = e.target.value;
  
  const fieldMap = {
    ES: 'ESin',
    EF: 'EFin',
    LS: 'LSin',
    LF: 'LFin'
  };
  
  if (fieldMap[field]) {
    state[fieldMap[field]][taskId] = value;
    
    // Re-render controls to show/hide Submit button in real-time for custom projects
    if (!isDefaultProject(state.currentProjectId)) {
      const project = getCurrentProject();
      const computed = computeCPM(project.tasks, state.minStart);
      renderControls(project, computed);
    }
  }
}

// ============================================================================
// EVENT HANDLERS - DRAGGING
// ============================================================================

function handleBarMouseDown(e) {
  const taskId = e.currentTarget.dataset.taskId;
  const project = getCurrentProject();

  if (state.stage !== "interactive" && isDefaultProject(state.currentProjectId)) return;
  
  const computed = computeCPM(project.tasks, state.minStart);
  const orig = state.minStart[taskId] || computed.ES[taskId];
  
  state.dragging = { id: taskId, startX: e.clientX, origStart: orig };
}

function handleMouseMove(e) {
  if (!state.dragging) return;
  
  const project = getCurrentProject();
  if (!isDefaultProject(state.currentProjectId)) return;
  
  // Get original computed values
  const originalComputed = computeCPM(project.tasks, state.minStart);
  const originalMaxEF = Math.max(...project.tasks.map(t => originalComputed.EF[t.id]));
  
  // Calculate new position
  const dx = e.clientX - state.dragging.startX;
  const deltaUnits = Math.round(dx / state.unitWidth);
  const newStart = Math.max(0, state.dragging.origStart + deltaUnits);
  
  // Compute new values with proposed change
  const newMinStart = { ...state.minStart, [state.dragging.id]: newStart };
  const newComputed = computeCPM(project.tasks, newMinStart);
  
  // Find the last task (one with no successors)
  const lastTasks = project.tasks.filter(task => 
    !project.tasks.some(t => t.deps.includes(task.id))
  );
  
  // Get maximum EF of last tasks with new computation
  const newMaxEF = Math.max(...lastTasks.map(t => newComputed.EF[t.id]));
  
  // Show warning if timeline extends
  if (newMaxEF > originalMaxEF) {
    if (!state.warningShown) { // Prevent multiple alerts
      alert('Warning - this is extending the deadline of your project');
      state.warningShown = true;
    }
  } else {
    state.warningShown = false;
  }
  
  // Update state and render
  state.minStart[state.dragging.id] = newStart;
  render();
}

function propagateConstraints(taskId, project, computed, newMinStart) {
  const succs = project.tasks.filter(t => t.deps.includes(taskId)).map(t => t.id);
  
  for (const succId of succs) {
    const succTask = project.tasks.find(t => t.id === succId);
    const succPreds = succTask.deps;
    const succPredEF = Math.max(...succPreds.map(p => {
      const override = newMinStart[p] || computed.ES[p];
      const dur = project.tasks.find(t => t.id === p).duration;
      return Math.max(override, computed.ES[p]) + dur;
    }));
    const cur = newMinStart[succId] || computed.ES[succId];
    
    if (succPredEF > cur) {
      newMinStart[succId] = succPredEF;
      propagateConstraints(succId, project, computed, newMinStart);
    }
  }
}

function handleMouseUp() {
  if (state.dragging) {
    state.dragging = null;
    state.warningShown = false;
    render();
  }
}

// ============================================================================
// VALIDATION
// ============================================================================

function parseIntOrNaN(v) {
  const parsed = parseInt(v);
  return Number.isFinite(parsed) ? parsed : NaN;
}

function checkESEF() {
  const project = getCurrentProject();
  const computed = computeCPM(project.tasks, state.minStart);
  const { ok, details } = validateFields(project, computed, ['ES', 'EF']);
  
  if (ok) {
    showModal("Nice! ES/EF are correct", `
      <div>
        <p>Great work. Total duration is <b>${computed.projectDuration}</b> units.</p>
        <p>Now enter LS/LF for each task.</p>
      </div>
    `);
    state.stage = "lslf";
    render();
  } else {
    showModal("Not quite yet", `
      <div class="space-y-2">
        <p>Some ES/EF entries don't match the network calculation. Check:</p>
        <ul>${details.map(d => `<li>${d}</li>`).join('')}</ul>
      </div>
    `);
  }
}

function checkLSLF() {
  const project = getCurrentProject();
  const computed = computeCPM(project.tasks, state.minStart);
  const { ok, details } = validateFields(project, computed, ['LS', 'LF']);
  
  if (ok) {
    showModal("All correct!", `
      <div>
        <p>You've nailed the full CPM. Slack is shown inside each task.</p>
        <p>Drag tasks earlier/later to explore what happens within vs. beyond slack. Critical path tasks are red.</p>
      </div>
    `);
    state.stage = "interactive";
    render();
  } else {
    showModal("LS/LF have issues", `
      <div class="space-y-2">
        <p>Compare your LS/LF to the expected values:</p>
        <ul>${details.map(d => `<li>${d}</li>`).join('')}</ul>
      </div>
    `);
  }
}

function validateFields(project, computed, fields) {
  const details = [];
  let ok = true;
  
  for (const task of project.tasks) {
    const errors = fields.filter(field => {
      const userValue = parseIntOrNaN(state[`${field}in`][task.id]);
      return userValue !== computed[field][task.id];
    });
    
    if (errors.length > 0) {
      ok = false;
      const expected = fields.map(f => `${f}=${computed[f][task.id]}`).join(', ');
      details.push(`${task.id} (${task.name}): expected ${expected}`);
    }
  }
  
  return { ok, details };
}

// ============================================================================
// MODAL
// ============================================================================

function showModal(title, body) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-body').innerHTML = body;
  document.getElementById('modal').style.display = 'flex';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

// ============================================================================
// PROJECT MANAGEMENT
// ============================================================================

function addProject() {
  const hasCustomProject = state.projects.some(p => !isDefaultProject(p.id));
  if (hasCustomProject) {
    alert("You can only create one custom project. Delete the existing custom project first.");
    return;
  }
  
  const newProject = {
    id: `p${Date.now()}`,
    name: 'Custom Project',
    tasks: []
  };
  state.projects.push(newProject);
  state.currentProjectId = newProject.id;
  render();
}

function deleteProject() {
  if (isDefaultProject(state.currentProjectId)) {
    alert("Cannot delete default example projects. You can only delete your custom project.");
    return;
  }
  
  const project = getCurrentProject();
  if (confirm(`Delete project "${project.name}"?`)) {
    state.projects = state.projects.filter(p => p.id !== state.currentProjectId);
    state.currentProjectId = state.projects[0].id;
    render();
  }
}

function resetProjectData() {
  if (isDefaultProject(state.currentProjectId)) {
    alert("Cannot reset default example projects. You can only reset your custom project.");
    return;
  }
  
  showModal("Reset Custom Project", `
    <div>
      <p>Are you sure you want to reset this project?</p>
      <p style="margin-top: 0.75rem; color: #dc2626; font-weight: 500;">
        This will delete all tasks and cannot be undone.
      </p>
      <div class="form-actions" style="margin-top: 1.5rem;">
        <button class="btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn-primary" style="background-color: #dc2626;" onclick="confirmResetProject()">
          Yes, Reset Project
        </button>
      </div>
    </div>
  `);
}

function confirmResetProject() {
  state.projects = state.projects.map(p => 
    p.id === state.currentProjectId ? { ...p, tasks: [] } : p
  );
  resetProjectState();
  closeModal();
  render();
}

function updateProjectName(name) {
  state.projects = state.projects.map(p => 
    p.id === state.currentProjectId ? { ...p, name } : p
  );
}

// ============================================================================
// TASK MANAGEMENT
// ============================================================================

function addTask() {
  state.editingTask = null;
  openTaskEditor();
}

function editTask(taskId) {
  const project = getCurrentProject();
  state.editingTask = project.tasks.find(t => t.id === taskId);
  openTaskEditor();
}

function deleteTask(taskId) {
  if (confirm(`Delete task ${taskId}?`)) {
    state.projects = state.projects.map(p => {
      if (p.id === state.currentProjectId) {
        const newTasks = p.tasks
          .filter(t => t.id !== taskId)
          .map(t => ({ ...t, deps: t.deps.filter(d => d !== taskId) }));
        return { ...p, tasks: newTasks };
      }
      return p;
    });
    render();
  }
}

function openTaskEditor() {
  const project = getCurrentProject();
  const modal = document.getElementById('task-editor-modal');
  
  if (state.editingTask) {
    document.getElementById('task-id').value = state.editingTask.id;
    document.getElementById('task-id').disabled = true;
    document.getElementById('task-name-input').value = state.editingTask.name;
    document.getElementById('task-duration').value = state.editingTask.duration;
    document.getElementById('task-editor-title').textContent = 'Edit Task';
  } else {
    const nextId = generateNextTaskId(project);
    document.getElementById('task-id').value = nextId;
    document.getElementById('task-id').disabled = false;
    document.getElementById('task-name-input').value = '';
    document.getElementById('task-duration').value = '3';
    document.getElementById('task-editor-title').textContent = 'Add New Task';
  }
  
  renderDependencyList();
  modal.style.display = 'flex';
}

function generateNextTaskId(project) {
  const existingIds = project.tasks.map(t => t.id);
  for (let i = 0; i < 26; i++) {
    const testId = String.fromCharCode(65 + i);
    if (!existingIds.includes(testId)) {
      return testId;
    }
  }
  return "Z";
}

function renderDependencyList() {
  const project = getCurrentProject();
  const container = document.getElementById('deps-list');
  const currentId = document.getElementById('task-id').value;
  const availableDeps = project.tasks.filter(t => t.id !== currentId);
  
  if (availableDeps.length === 0) {
    container.innerHTML = '<div class="deps-empty">No other tasks available</div>';
    return;
  }
  
  const currentDeps = state.editingTask ? state.editingTask.deps : [];
  container.innerHTML = '';
  
  availableDeps.forEach(t => {
    const label = document.createElement('label');
    label.className = 'dep-checkbox';
    label.innerHTML = `
      <input type="checkbox" value="${t.id}" ${currentDeps.includes(t.id) ? 'checked' : ''}>
      <span>${t.id} - ${t.name}</span>
    `;
    container.appendChild(label);
  });
}

function closeTaskEditor() {
  document.getElementById('task-editor-modal').style.display = 'none';
  state.editingTask = null;
}

function saveTask() {
  const id = document.getElementById('task-id').value;
  const name = document.getElementById('task-name-input').value;
  const duration = parseInt(document.getElementById('task-duration').value);
  
  if (!id || !name || isNaN(duration) || duration < 1) {
    alert("Please fill in all fields correctly (duration must be at least 1)");
    return;
  }
  
  const deps = Array.from(document.querySelectorAll('#deps-list input:checked')).map(cb => cb.value);
  const task = { id, name, duration, deps };
  
  state.projects = state.projects.map(p => {
    if (p.id === state.currentProjectId) {
      const existingIndex = p.tasks.findIndex(t => t.id === task.id);
      if (existingIndex >= 0) {
        const newTasks = [...p.tasks];
        newTasks[existingIndex] = task;
        return { ...p, tasks: newTasks };
      } else {
        return { ...p, tasks: [...p.tasks, task] };
      }
    }
    return p;
  });
  
  closeTaskEditor();
  render();
}


// ============================================================================
// WINDOW HANDLERS
// ============================================================================

function handleResize() {
  const project = getCurrentProject();
  if (project.tasks.length > 0) {
    renderGantt();
  }
}

// ============================================================================
// INITIALIZATION
// ============================================================================


document.addEventListener('DOMContentLoaded', () => {
  // Ensure initial state is properly set
  state.projects = JSON.parse(JSON.stringify(INITIAL_PROJECTS));
  state.currentProjectId = INITIAL_PROJECTS[0].id;
  state.stage = "esef";
  
  // Initialize empty state objects
  resetProjectState();
  
  // Add window resize listener
  window.addEventListener('resize', handleResize);
  window.addEventListener('mousemove', handleMouseMove);
  window.addEventListener('mouseup', handleMouseUp);
  
  // Perform initial render
  handleResize(); // This ensures proper chart sizing
  render(); // This will render all components
});

  </script>
</body>
</html>